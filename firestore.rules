rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ====== FONCTIONS HELPER ======
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'admin@neotech-consulting.com';
    }
    
    function isManagerOrAdmin() {
      return isAuthenticated() && (
        isAdmin() ||
        exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role in ['admin', 'manager', 'owner']
      );
    }
    
    // ====== COLLECTIONS PUBLIQUES (SITE WEB) ======
    
    // Propriétés - lecture publique pour le site web
    match /Rent_properties/{document} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Colocataires - lecture publique pour calculer l'occupation
    match /Rent_colocataires/{document} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // ====== ANALYTICS ET TRACKING ======
    
    // Analytics du site web - Collection: rent_analytics
    match /rent_analytics/{analyticsId} {
      // Permettre l'écriture anonyme pour le tracking public du site
      allow create: if true;
      // Permettre la lecture pour tous les utilisateurs authentifiés
      allow read: if isAuthenticated();
      // Seuls les admins peuvent modifier/supprimer
      allow update, delete: if isAdmin();
    }
    
    // ====== GESTION DES UTILISATEURS ET RÔLES ======
    
    // Rôles utilisateurs - Collection: user_roles
    match /user_roles/{userId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == userId || isAdmin());
      allow write: if isAdmin();
      allow create: if isAdmin();
    }
    
    // Configuration des permissions - Collection: employee_permissions
    match /employee_permissions/{permissionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ====== DEMANDES D'INSCRIPTION ======
    
    // Demandes d'inscription propriétaires - Collection: owner_registration_requests
    match /owner_registration_requests/{requestId} {
      // Permettre la création par des utilisateurs non authentifiés (site public)
      allow create: if true;
      // Seuls les admins et managers peuvent lire, modifier et supprimer
      allow read, write, delete: if isManagerOrAdmin();
    }
    
    // ====== SYSTÈME DE COMMUNICATION ======
    
    // Conversations - Collection: conversations
    match /conversations/{conversationId} {
      allow create: if true; // Visiteurs peuvent créer des conversations
      allow read: if isAuthenticated(); // Staff authentifié peut lire
      allow write: if isAuthenticated();
      
      // Sous-collection des messages
      match /messages/{messageId} {
        allow create: if true; // Visiteurs peuvent envoyer des messages
        allow read, write: if isAuthenticated();
      }
    }
    
    // Messages de chat - Collection: rent_messages
    match /rent_messages/{messageId} {
      allow create: if true; // Visiteurs et utilisateurs peuvent créer des messages
      allow read: if isAuthenticated(); // Staff peut lire tous les messages
      allow write: if isAuthenticated(); // Staff peut modifier les messages
    }
    
    // Notifications - Collection: notifications
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow write: if isManagerOrAdmin();
      allow create: if isAuthenticated();
    }
    
    // ====== CONFIGURATION ======
    
    // Configuration du site web - Collection: website_config
    match /website_config/{configId} {
      allow read: if true; // Public pour le site web
      allow write: if isAdmin();
    }
    
    // Configuration de l'entreprise - Collection: company_config
    match /company_config/{configId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ====== DOCUMENTS ET FICHIERS ======
    
    // Documents des locataires - Collection: tenant_documents
    match /tenant_documents/{documentId} {
      allow read, write: if isManagerOrAdmin() ||
        (isAuthenticated() && resource.data.tenantId == request.auth.uid);
    }
    
    // Fichiers uploadés - Collection: uploaded_files
    match /uploaded_files/{fileId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
        request.auth.uid == resource.data.uploadedBy;
      allow create: if isAuthenticated();
    }
    
    // ====== LOGS ET AUDIT ======
    
    // Logs d'audit - Collection: audit_logs
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
    }
    
    // Sessions utilisateur - Collection: user_sessions
    match /user_sessions/{sessionId} {
      allow read, write: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ====== AUTRES COLLECTIONS EXISTANTES ======
    
    // Toutes les autres collections nécessitent une authentification
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}